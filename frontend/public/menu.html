<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu Management - Infinity Cafe</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/responsive-tables.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body data-page="menu">
  <!-- Header -->
  <nav class="header">
    <div class="header-brand">
      <h1 class="header-title" id="navbar-title">Management Menu</h1>
      <p class="header-subtitle">Stephany | Barista</p>
    </div>
    <div class="header-menu">
      <button class="nav-btn" id="nav-dashboard" data-url="dashboard">Dashboard</button>
      <button class="nav-btn active" id="nav-menu" data-url="management-menu">Management Menu</button>
    </div>
    <div class="header-right">
      <div class="search-container">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input type="text" placeholder="Search" class="search-input">
      </div>
      <div class="kitchen-status-container">
        <label class="switch">
          <input type="checkbox" id="kitchen-toggle" checked>
          <span class="slider"></span>
        </label>
        <!-- <span id="kitchen-status-text" class="kitchen-status-text">BUKA</span> -->
      </div>
    </div>
  </nav>

  <!-- Kitchen Off Banner -->
  <div id="kitchen-off-banner" class="kitchen-off-banner hidden">
      ðŸš« Dapur sedang OFF. Tidak dapat menerima/memproses pesanan.
  </div>

  <!-- Offline Banner -->
  <div id="offline-banner" class="offline-banner hidden">
      ðŸ”Œ Gagal ambil data. Cek koneksi.
  </div>

  <!-- Main Content -->
  <div class="main-container">
<div class="content-area">
    
      <!-- Greeting Message -->
      <div class="greeting-message">
        <h2>Hi, John Doe, here's list menu!</h2>
        <p class="greeting-date" id="greeting-date">Monday, 14th July 2025</p>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button id="tab-menu" class="tab-btn tab-active" onclick="switchTab('menu')">MENU</button>
        <button id="tab-flavors" class="tab-btn" onclick="switchTab('flavors')">FLAVORS</button>
        <button class="add-order-btn" id="add-new-btn" onclick="openAddModal()">ADD NEW MENU</button>
      </div>

      <!-- Tab Content -->
      <div id="tab-content">
        <!-- Menu Tab (Default) -->
        <div id="tab-menu-content" class="tab-panel active">
          <div class="table-container">
            <!-- Search and Filter Section for Menu -->
            <div class="search-filter-section">
              <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="menu-search" placeholder="Search menu..." class="search-input">
              </div>
              <div class="filter-container">
                <button class="filter-btn" onclick="toggleFilterMenu()">
                  <i class="fas fa-filter"></i>
                  Filter
                </button>
                <div class="filter-dropdown" id="menu-filter-dropdown">
                  <div class="filter-group">
                    <label>Status:</label>
                    <select id="menu-status-filter">
                      <option value="">All</option>
                      <option value="Yes">Available</option>
                      <option value="No">Not Available</option>
                    </select>
            </div>
                  <div class="filter-group">
                    <label>Price Range:</label>
                    <div class="price-range">
                      <input type="number" id="menu-price-min" placeholder="Min" class="price-input">
                      <span>-</span>
                      <input type="number" id="menu-price-max" placeholder="Max" class="price-input">
                    </div>
                  </div>
                  <div class="filter-actions">
                    <button class="apply-filter-btn" onclick="applyMenuFilter()">Apply</button>
                    <button class="clear-filter-btn" onclick="clearMenuFilter()">Clear</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Table Info -->
            <div class="table-info">
              <span id="menu-table-info">Showing 0 of 0 entries</span>
            </div>
            
            <table id="menu-table">
              <thead>
                <tr>
                  <th>NO</th>
                  <th>MENU NAME</th>
                  <th>PRICE</th>
                  <th>IS AVAIL</th>
                  <th>FLAVORS</th>
                  <th class="action-header">ACTION</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be populated by script.js -->
              </tbody>
            </table>
            
            <!-- Pagination for Menu -->
            <div class="pagination-container" id="menu-pagination">
              <div class="pagination-info">
                <span id="menu-pagination-info">Page 1 of 1</span>
              </div>
              <div class="pagination-controls">
                <button class="pagination-btn" id="menu-prev-btn" onclick="changeMenuPage(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div class="page-numbers" id="menu-page-numbers">
                  <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" id="menu-next-btn" onclick="changeMenuPage(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="pagination-size">
                <label>Show:</label>
                <select id="menu-page-size" onchange="changeMenuPageSize()">
                  <option value="5">5</option>
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
                <span>entries</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Flavors Tab -->
        <div id="tab-flavors-content" class="tab-panel">
          <div class="table-container">
            <!-- Search and Filter Section for Flavors -->
            <div class="search-filter-section">
              <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="flavor-search" placeholder="Search flavors..." class="search-input">
              </div>
              <div class="filter-container">
                <button class="filter-btn" onclick="toggleFilterFlavor()">
                  <i class="fas fa-filter"></i>
                  Filter
                </button>
                <div class="filter-dropdown" id="flavor-filter-dropdown">
                  <div class="filter-group">
                    <label>Price Range:</label>
                    <div class="price-range">
                      <input type="number" id="flavor-price-min" placeholder="Min" class="price-input">
                      <span>-</span>
                      <input type="number" id="flavor-price-max" placeholder="Max" class="price-input">
            </div>
                  </div>
                  <div class="filter-actions">
                    <button class="apply-filter-btn" onclick="applyFlavorFilter()">Apply</button>
                    <button class="clear-filter-btn" onclick="clearFlavorFilter()">Clear</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Table Info -->
            <div class="table-info">
              <span id="flavor-table-info">Showing 0 of 0 entries</span>
            </div>
            
            <table id="flavors-table">
              <thead>
                <tr>
                  <th>NO</th>
                  <th>FLAVOUR NAME</th>
                  <th>ADDITIONAL PRICE</th>
                  <th class="action-header">ACTION</th>
                </tr>
              </thead>
              <tbody>

              </tbody>
            </table>
            
            <!-- Pagination for Flavors -->
            <div class="pagination-container" id="flavor-pagination">
              <div class="pagination-info">
                <span id="flavor-pagination-info">Page 1 of 1</span>
          </div>
              <div class="pagination-controls">
                <button class="pagination-btn" id="flavor-prev-btn" onclick="changeFlavorPage(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div class="page-numbers" id="flavor-page-numbers">
                  <!-- Page numbers will be generated here -->
        </div>
                <button class="pagination-btn" id="flavor-next-btn" onclick="changeFlavorPage(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
        </div>
              <div class="pagination-size">
                <label>Show:</label>
                <select id="flavor-page-size" onchange="changeFlavorPageSize()">
                  <option value="5">5</option>
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
                <span>entries</span>
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- Add Menu Modal -->
  <div id="add-menu-modal" class="modal hidden">
    <div class="modal-content add-menu-modal">
      <button class="modal-close" onclick="closeAddMenuModal()">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.5 5.5L5.5 16.5M5.5 5.5L16.5 16.5" stroke="#B3261E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h3 class="modal-title">Add New Menu</h3>
      <form id="add-menu-form">
        <div class="form-group">
          <label for="base-name">Menu Name</label>
          <input type="text" id="base-name" name="base-name" placeholder="Type Here ..." required />
        </div>
        <div class="form-group">
          <label for="base-price">Price</label>
          <input type="number" id="base-price" name="base-price" placeholder="Type Here ..." required />
        </div>
        <div class="form-group">
          <label for="is-avail">Is Avail</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="is-avail-true" name="is-avail" value="true" checked />
              <label for="is-avail-true">True</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="is-avail-false" name="is-avail" value="false" />
              <label for="is-avail-false">False</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="menu-flavors">Available Flavors</label>
          <div class="flavor-selector">
            <div class="flavor-selector-header">
              <button type="button" class="select-all-btn" onclick="toggleAllFlavors()">Select All</button>
              <button type="button" class="clear-all-btn" onclick="clearAllFlavors()">Clear All</button>
            </div>
            <div class="flavor-checkboxes" id="flavor-checkboxes">
              <!-- Flavor checkboxes will be populated here -->
            </div>
          </div>
        </div>
        <button type="submit" class="save-button">
          <svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.5 4.5H2.5C1.95 4.5 1.5 4.95 1.5 5.5V12.5C1.5 13.05 1.95 13.5 2.5 13.5H12.5C13.05 13.5 13.5 13.05 13.5 12.5V5.5C13.5 4.95 13.05 4.5 12.5 4.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4.5 4.5V2.5C4.5 1.95 4.95 1.5 5.5 1.5H9.5C10.05 1.5 10.5 1.95 10.5 2.5V4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Save Menu</span>
        </button>
      </form>
      <div id="form-error" class="error"></div>
    </div>
  </div>

  <!-- Add Flavour Modal -->
  <div id="add-flavour-modal" class="modal hidden">
    <div class="modal-content add-flavour-modal">
      <button class="modal-close" onclick="closeAddFlavourModal()">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.5 5.5L5.5 16.5M5.5 5.5L16.5 16.5" stroke="#B3261E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h3 class="modal-title">Create New Flavour</h3>
      <form id="add-flavour-form">
        <div class="form-group">
          <label for="flavour-name">Flavour Name</label>
          <input type="text" id="flavour-name" name="flavour-name" placeholder="Type Here ..." required />
        </div>
        <div class="form-group">
          <label for="additional-price">Additional Price</label>
          <input type="number" id="additional-price" name="additional-price" placeholder="Type Here ..." required />
        </div>
        <button type="submit" class="save-button">
          <svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.5 4.5H2.5C1.95 4.5 1.5 4.95 1.5 5.5V12.5C1.5 13.05 1.95 13.5 2.5 13.5H12.5C13.05 13.5 13.5 13.05 13.5 12.5V5.5C13.5 4.95 13.05 4.5 12.5 4.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4.5 4.5V2.5C4.5 1.95 4.95 1.5 5.5 1.5H9.5C10.05 1.5 10.5 1.95 10.5 2.5V4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Save Flavour</span>
        </button>
      </form>
      <div id="flavour-form-error" class="error"></div>
    </div>
  </div>

  <!-- View Menu Modal -->
  <div id="view-menu-modal" class="modal hidden">
    <div class="modal-content view-modal">
      <button class="modal-close" onclick="closeViewMenuModal()">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.5 5.5L5.5 16.5M5.5 5.5L16.5 16.5" stroke="#B3261E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h3 class="modal-title">Menu Details</h3>
      <div class="view-content">
        <div class="view-item">
          <label>Menu Name:</label>
          <span id="view-menu-name"></span>
        </div>
        <div class="view-item">
          <label>Price:</label>
          <span id="view-menu-price"></span>
        </div>
        <div class="view-item">
          <label>Available:</label>
          <span id="view-menu-available"></span>
        </div>
        <div class="view-item">
          <label>Available Flavors:</label>
          <span id="view-menu-flavors" class="flavor-display"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeViewMenuModal()">Close</button>
        <button class="modal-btn" onclick="editFromView()">Edit</button>
      </div>
    </div>
  </div>

  <!-- View Flavor Modal -->
  <div id="view-flavor-modal" class="modal hidden">
    <div class="modal-content view-modal">
      <button class="modal-close" onclick="closeViewFlavorModal()">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.5 5.5L5.5 16.5M5.5 5.5L16.5 16.5" stroke="#B3261E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h3 class="modal-title">Flavor Details</h3>
      <div class="view-content">
        <div class="view-item">
          <label>Flavor Name:</label>
          <span id="view-flavor-name"></span>
        </div>
        <div class="view-item">
          <label>Additional Price:</label>
          <span id="view-flavor-price"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeViewFlavorModal()">Close</button>
        <button class="modal-btn" onclick="editFlavorFromView()">Edit</button>
      </div>
    </div>
  </div>

  
  <script src="script.js"></script>

  <script>
    const BASE_URL = "";

    // Global variables for pagination and filtering
    let allMenus = [];
    let allFlavors = [];
    let filteredMenus = [];
    let filteredFlavors = [];
    let selectedFlavorIds = [];
    
    // Data loading state
    let menusLoaded = false;
    let flavorsLoaded = false;
    
    // Menu pagination state
    let menuCurrentPage = 1;
    let menuPageSize = 10;
    let menuTotalPages = 1;
    
    // Flavor pagination state
    let flavorCurrentPage = 1;
    let flavorPageSize = 10;
    let flavorTotalPages = 1;

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}-content`).classList.add('active');
      
      // Update button text based on active tab
      const addButton = document.getElementById('add-new-btn');
      if (tab === 'flavors') {
        addButton.textContent = 'ADD NEW FLAVOUR';
        loadFlavors();
      } else if (tab === 'menu') {
        addButton.textContent = 'ADD NEW MENU';
        // Load menus (flavors are included in menu data)
        loadMenus().catch(error => {
          console.error('Error loading data for menu tab:', error);
        });
      }
    }

    // Load all menus with pagination
    async function loadMenus() {
      try {
        const response = await fetch(`${BASE_URL}/menu`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        let menus;
        try {
          menus = await response.json();
        } catch (parseError) {
          throw new Error('Invalid JSON response from server');
        }
        
        allMenus = menus || [];
        filteredMenus = [...allMenus];
        menusLoaded = true;
        
        // Always render table, flavors are included in menu data
        await renderMenuTable();
        updateMenuPagination();
        
        // Load flavors separately for flavor selector (if not loaded yet)
        if (!flavorsLoaded) {
          try {
            await loadFlavors();
          } catch (error) {
            console.error('Error loading flavors for selector:', error);
          }
        }
        
        return allMenus; // Return menus for promise chaining
      } catch (error) {
        console.error('Error loading menus:', error);
        const tbody = document.querySelector('#menu-table tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading menus: ' + error.message + '</td></tr>';
        throw error;
      }
    }

    // Render menu table with pagination
    async function renderMenuTable() {
        const tbody = document.querySelector('#menu-table tbody');
        tbody.innerHTML = '';
        
        // Ensure menu data is loaded before rendering
        if (!menusLoaded) {
          await loadMenus();
        }
        
      const startIndex = (menuCurrentPage - 1) * menuPageSize;
      const endIndex = startIndex + menuPageSize;
      const currentPageData = filteredMenus.slice(startIndex, endIndex);
      
      // Debug logging
      console.log('Rendering menu table with:', {
        allMenus: allMenus.length,
        allFlavors: allFlavors.length,
        currentPageData: currentPageData.length
      });
      
      if (currentPageData.length > 0) {
        currentPageData.forEach((menu, index) => {
            // Get flavor names for this menu
            let flavorText = 'None';
            console.log('menu.flavors:', menu.flavors);
            if (menu.flavors && menu.flavors.length > 0) {
              console.log(`Menu ${menu.base_name} has flavors:`, menu.flavors);
              const flavorTags = [];
              for (const flavor of menu.flavors) {
                flavorTags.push(`<span class="flavor-tag">${flavor.flavor_name}</span>`);
              }
              flavorText = flavorTags.join('');
              console.log(`Final flavor text for ${menu.base_name}:`, flavorText);
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${startIndex + index + 1}</td>
              <td>${menu.base_name}</td>
              <td>${menu.base_price}</td>
              <td>${menu.isAvail ? 'Yes' : 'No'}</td>
              <td class="flavor-cell">${flavorText}</td>
              <td class="action-header">
                <button class="table-action-btn" onclick="viewMenu('${menu.id}')"><i class="fas fa-eye"></i></button>
                <button class="table-action-btn" onclick="editMenu('${menu.id}')"><i class="fas fa-edit"></i></button>
                <button class="table-action-btn" onclick="deleteMenu('${menu.id}')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No menus found</td></tr>';
        }
      
      updateMenuTableInfo();
    }

    // Update menu pagination
    function updateMenuPagination() {
      menuTotalPages = Math.ceil(filteredMenus.length / menuPageSize);
      if (menuTotalPages === 0) menuTotalPages = 1;
      
      if (menuCurrentPage > menuTotalPages) {
        menuCurrentPage = menuTotalPages;
      }
      
      renderMenuPagination();
    }

    // Render menu pagination controls
    function renderMenuPagination() {
      const pageNumbers = document.getElementById('menu-page-numbers');
      const prevBtn = document.getElementById('menu-prev-btn');
      const nextBtn = document.getElementById('menu-next-btn');
      const paginationInfo = document.getElementById('menu-pagination-info');
      
      // Update pagination info
      paginationInfo.textContent = `Page ${menuCurrentPage} of ${menuTotalPages}`;
      
      // Update prev/next buttons
      prevBtn.disabled = menuCurrentPage === 1;
      nextBtn.disabled = menuCurrentPage === menuTotalPages;
      
      // Generate page numbers
      pageNumbers.innerHTML = '';
      const maxVisiblePages = 5;
      let startPage = Math.max(1, menuCurrentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(menuTotalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-number ${i === menuCurrentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
          menuCurrentPage = i;
          renderMenuTable();
          renderMenuPagination();
        };
        pageNumbers.appendChild(pageBtn);
      }
    }

    // Update menu table info
    function updateMenuTableInfo() {
      const tableInfo = document.getElementById('menu-table-info');
      const startIndex = (menuCurrentPage - 1) * menuPageSize + 1;
      const endIndex = Math.min(menuCurrentPage * menuPageSize, filteredMenus.length);
      const total = filteredMenus.length;
      
      tableInfo.textContent = `Showing ${startIndex} to ${endIndex} of ${total} entries`;
    }

    // Change menu page
    async function changeMenuPage(direction) {
      const newPage = menuCurrentPage + direction;
      if (newPage >= 1 && newPage <= menuTotalPages) {
        menuCurrentPage = newPage;
        await renderMenuTable();
        renderMenuPagination();
      }
    }

    // Change menu page size
    async function changeMenuPageSize() {
      menuPageSize = parseInt(document.getElementById('menu-page-size').value);
      menuCurrentPage = 1;
      updateMenuPagination();
      await renderMenuTable();
    }

    // Ensure data is loaded
    async function ensureDataLoaded() {
      try {
        if (!menusLoaded) {
          await loadMenus();
        }
        // Only load flavors if needed for flavor selector
        if (!flavorsLoaded) {
          await loadFlavors();
        }
      } catch (error) {
        console.error('Error ensuring data is loaded:', error);
        // Set flags to false to allow retry
        menusLoaded = false;
        flavorsLoaded = false;
        throw error;
      }
    }
    
    // Load flavors with pagination
    async function loadFlavors() {
      try {
        const response = await fetch(`${BASE_URL}/flavors`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        let flavors;
        try {
          flavors = await response.json();
        } catch (parseError) {
          throw new Error('Invalid JSON response from server');
        }
        
        allFlavors = flavors || [];
        filteredFlavors = [...allFlavors];
        flavorsLoaded = true;
        renderFlavorTable();
        updateFlavorPagination();
        
        // No need to re-render menu table since flavors are included in menu data
        
        return allFlavors; // Return flavors for promise chaining
      } catch (error) {
        console.error('Error loading flavors:', error);
        const tbody = document.querySelector('#flavors-table tbody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error loading flavors: ' + error.message + '</td></tr>';
        throw error;
      }
    }

    // Render flavor table with pagination
    function renderFlavorTable() {
        const tbody = document.querySelector('#flavors-table tbody');
        tbody.innerHTML = '';
        
      const startIndex = (flavorCurrentPage - 1) * flavorPageSize;
      const endIndex = startIndex + flavorPageSize;
      const currentPageData = filteredFlavors.slice(startIndex, endIndex);
      
      if (currentPageData.length > 0) {
        currentPageData.forEach((flavor, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${startIndex + index + 1}</td>
              <td>${flavor.flavor_name}</td>
              <td>${flavor.additional_price}</td>
              <td class="action-header">
                <button class="table-action-btn" onclick="viewFlavor('${flavor.id}')"><i class="fas fa-eye"></i></button>
                <button class="table-action-btn" onclick="editFlavor('${flavor.id}')"><i class="fas fa-edit"></i></button>
                <button class="table-action-btn" onclick="deleteFlavor('${flavor.id}')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No flavors found</td></tr>';
        }
      
      updateFlavorTableInfo();
    }

    // Update flavor pagination
    function updateFlavorPagination() {
      flavorTotalPages = Math.ceil(filteredFlavors.length / flavorPageSize);
      if (flavorTotalPages === 0) flavorTotalPages = 1;
      
      if (flavorCurrentPage > flavorTotalPages) {
        flavorCurrentPage = flavorTotalPages;
      }
      
      renderFlavorPagination();
    }

    // Render flavor pagination controls
    function renderFlavorPagination() {
      const pageNumbers = document.getElementById('flavor-page-numbers');
      const prevBtn = document.getElementById('flavor-prev-btn');
      const nextBtn = document.getElementById('flavor-next-btn');
      const paginationInfo = document.getElementById('flavor-pagination-info');
      
      // Update pagination info
      paginationInfo.textContent = `Page ${flavorCurrentPage} of ${flavorTotalPages}`;
      
      // Update prev/next buttons
      prevBtn.disabled = flavorCurrentPage === 1;
      nextBtn.disabled = flavorCurrentPage === flavorTotalPages;
      
      // Generate page numbers
      pageNumbers.innerHTML = '';
      const maxVisiblePages = 5;
      let startPage = Math.max(1, flavorCurrentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(flavorTotalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-number ${i === flavorCurrentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
          flavorCurrentPage = i;
          renderFlavorTable();
          renderFlavorPagination();
        };
        pageNumbers.appendChild(pageBtn);
      }
    }

    // Update flavor table info
    function updateFlavorTableInfo() {
      const tableInfo = document.getElementById('flavor-table-info');
      const startIndex = (flavorCurrentPage - 1) * flavorPageSize + 1;
      const endIndex = Math.min(flavorCurrentPage * flavorPageSize, filteredFlavors.length);
      const total = filteredFlavors.length;
      
      tableInfo.textContent = `Showing ${startIndex} to ${endIndex} of ${total} entries`;
    }

    // Change flavor page
    function changeFlavorPage(direction) {
      const newPage = flavorCurrentPage + direction;
      if (newPage >= 1 && newPage <= flavorTotalPages) {
        flavorCurrentPage = newPage;
        renderFlavorTable();
        renderFlavorPagination();
      }
    }

    // Change flavor page size
    function changeFlavorPageSize() {
      flavorPageSize = parseInt(document.getElementById('flavor-page-size').value);
      flavorCurrentPage = 1;
      updateFlavorPagination();
      renderFlavorTable();
    }

    // Filter functions
    function toggleFilterMenu() {
      const dropdown = document.getElementById('menu-filter-dropdown');
      dropdown.classList.toggle('show');
    }

    function toggleFilterFlavor() {
      const dropdown = document.getElementById('flavor-filter-dropdown');
      dropdown.classList.toggle('show');
    }

    async function applyMenuFilter() {
      const searchTerm = document.getElementById('menu-search').value.toLowerCase();
      const statusFilter = document.getElementById('menu-status-filter').value;
      const priceMin = document.getElementById('menu-price-min').value;
      const priceMax = document.getElementById('menu-price-max').value;
      
      filteredMenus = allMenus.filter(menu => {
        // Search filter
        const matchesSearch = menu.base_name.toLowerCase().includes(searchTerm) ||
                            menu.base_price.toString().includes(searchTerm);
        
        // Status filter
        const matchesStatus = !statusFilter || 
                            (statusFilter === 'Yes' && menu.isAvail) ||
                            (statusFilter === 'No' && !menu.isAvail);
        
        // Price filter
        const matchesPrice = (!priceMin || menu.base_price >= parseInt(priceMin)) &&
                           (!priceMax || menu.base_price <= parseInt(priceMax));
        
        return matchesSearch && matchesStatus && matchesPrice;
      });
      
      menuCurrentPage = 1;
      updateMenuPagination();
      await renderMenuTable();
      
      // Close dropdown
      document.getElementById('menu-filter-dropdown').classList.remove('show');
    }

    async function clearMenuFilter() {
      document.getElementById('menu-search').value = '';
      document.getElementById('menu-status-filter').value = '';
      document.getElementById('menu-price-min').value = '';
      document.getElementById('menu-price-max').value = '';
      
      filteredMenus = [...allMenus];
      menuCurrentPage = 1;
      updateMenuPagination();
      await renderMenuTable();
      
      // Close dropdown
      document.getElementById('menu-filter-dropdown').classList.remove('show');
    }

    function applyFlavorFilter() {
      const searchTerm = document.getElementById('flavor-search').value.toLowerCase();
      const priceMin = document.getElementById('flavor-price-min').value;
      const priceMax = document.getElementById('flavor-price-max').value;
      
      filteredFlavors = allFlavors.filter(flavor => {
        // Search filter
        const matchesSearch = flavor.flavor_name.toLowerCase().includes(searchTerm) ||
                            flavor.additional_price.toString().includes(searchTerm);
        
        // Price filter
        const matchesPrice = (!priceMin || flavor.additional_price >= parseInt(priceMin)) &&
                           (!priceMax || flavor.additional_price <= parseInt(priceMax));
        
        return matchesSearch && matchesPrice;
      });
      
      flavorCurrentPage = 1;
      updateFlavorPagination();
      renderFlavorTable();
      
      // Close dropdown
      document.getElementById('flavor-filter-dropdown').classList.remove('show');
    }

    function clearFlavorFilter() {
      document.getElementById('flavor-search').value = '';
      document.getElementById('flavor-price-min').value = '';
      document.getElementById('flavor-price-max').value = '';
      
      filteredFlavors = [...allFlavors];
      flavorCurrentPage = 1;
      updateFlavorPagination();
      renderFlavorTable();
      
      // Close dropdown
      document.getElementById('flavor-filter-dropdown').classList.remove('show');
    }

    // Close filter dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const menuFilterDropdown = document.getElementById('menu-filter-dropdown');
      const flavorFilterDropdown = document.getElementById('flavor-filter-dropdown');
      
      if (!event.target.closest('.filter-container')) {
        menuFilterDropdown.classList.remove('show');
        flavorFilterDropdown.classList.remove('show');
      }
    });

    // Save or update menu
    async function saveMenu() {
      const menuId = document.getElementById('add-menu-form').getAttribute('data-menu-id') || null;
      const baseName = document.getElementById('base-name').value;
      const basePrice = parseInt(document.getElementById('base-price').value);
      const isAvail = document.querySelector('input[name="is-avail"]:checked').value === 'true';

      const data = {
        base_name: baseName,
        base_price: basePrice,
        isAvail: isAvail,
        flavor_ids: selectedFlavorIds
      };

      try {
        let response;
        if (menuId) {
          response = await fetch(`${BASE_URL}/menu/${menuId}`, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`${BASE_URL}/menu`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (!response.ok) {
          let errorMessage = 'Failed to save menu';
          try {
            const errorData = await response.json();
            errorMessage = errorData.detail || errorData.error || errorMessage;
          } catch (parseError) {
            // If response is not JSON (e.g., HTML error page)
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }
        
        let result;
        try {
          result = await response.json();
          console.log('Menu saved successfully:', result);
        } catch (parseError) {
          console.log('Menu saved successfully (no JSON response)');
        }
        
        // Reset selectedFlavorIds before closing modal
        selectedFlavorIds = [];
        closeAddMenuModal();
        await loadMenus();
        
        // Menu table will be re-rendered automatically by loadMenus
        
        // Show success message
        const errorElement = document.getElementById('form-error');
        errorElement.textContent = 'Menu saved successfully!';
        errorElement.style.color = 'green';
        setTimeout(() => {
          errorElement.textContent = '';
          errorElement.style.color = '';
        }, 3000);
      } catch (error) {
        console.error('Error saving menu:', error);
        const errorElement = document.getElementById('form-error');
        errorElement.textContent = error.message || 'Error saving menu';
        errorElement.style.color = 'red';
      }
    }

    // Edit menu
    function editMenu(menuId) {
      fetch(`${BASE_URL}/menu/${menuId}`)
        .then(response => response.json())
        .then(menu => {
          document.getElementById('base-name').value = menu.base_name;
          document.getElementById('base-price').value = menu.base_price;
          
          // Set radio button based on isAvail value
          if (menu.isAvail) {
            document.getElementById('is-avail-true').checked = true;
          } else {
            document.getElementById('is-avail-false').checked = true;
          }
          
          // Set selected flavors
          selectedFlavorIds = menu.flavors ? menu.flavors.map(f => f.id) : [];
          console.log('Selected flavor IDs for edit:', selectedFlavorIds);
          
          document.getElementById('add-menu-form').setAttribute('data-menu-id', menuId);
          openAddMenuModal();
        })
        .catch(error => {
          console.error('Error loading menu for edit:', error);
          document.getElementById('form-error').textContent = 'Error loading menu for edit';
        });
    }

    // Delete menu
    async function deleteMenu(menuId) {
      if (confirm('Are you sure you want to delete this menu?')) {
        try {
          const response = await fetch(`${BASE_URL}/menu/${menuId}`, {
            method: "DELETE"
          });
          if (!response.ok) throw new Error('Failed to delete menu');
          await loadMenus();
          
          // Menu table will be re-rendered automatically by loadMenus
        } catch (error) {
          console.error('Error deleting menu:', error);
          document.getElementById('form-error').textContent = 'Error deleting menu';
        }
      }
    }

    // View menu
    async function viewMenu(menuId) {
      try {
        const response = await fetch(`${BASE_URL}/menu/${menuId}`);
        if (!response.ok) throw new Error('Failed to fetch menu details');
        
        const menu = await response.json();
        
        document.getElementById('view-menu-name').textContent = menu.base_name;
        document.getElementById('view-menu-price').textContent = `Rp ${menu.base_price.toLocaleString()}`;
        document.getElementById('view-menu-available').textContent = menu.isAvail ? 'Yes' : 'No';
        
        // Display available flavors
        let flavorsText = 'None';
        console.log('viewMenu menu.flavors:', menu.flavors);
        if (menu.flavors && menu.flavors.length > 0) {
          const flavorItems = [];
          for (const flavor of menu.flavors) {
            flavorItems.push(`<div class="flavor-item">${flavor.flavor_name}<span class="flavor-price">(+Rp ${flavor.additional_price.toLocaleString()})</span></div>`);
          }
          flavorsText = flavorItems.join('');
        }
        document.getElementById('view-menu-flavors').innerHTML = flavorsText;
        
        // Store the menu ID for edit functionality
        document.getElementById('view-menu-modal').setAttribute('data-menu-id', menuId);
        
        document.getElementById('view-menu-modal').classList.remove('hidden');
      } catch (error) {
        console.error('Error viewing menu:', error);
        alert('Error loading menu details');
      }
    }

    // View flavor
    async function viewFlavor(flavorId) {
      try {
        const response = await fetch(`${BASE_URL}/flavors/${flavorId}`);
        if (!response.ok) throw new Error('Failed to fetch flavor details');
        
        const flavor = await response.json();
        
        document.getElementById('view-flavor-name').textContent = flavor.flavor_name;
        document.getElementById('view-flavor-price').textContent = `Rp ${flavor.additional_price.toLocaleString()}`;
        
        // Store the flavor ID for edit functionality
        document.getElementById('view-flavor-modal').setAttribute('data-flavor-id', flavorId);
        
        document.getElementById('view-flavor-modal').classList.remove('hidden');
      } catch (error) {
        console.error('Error viewing flavor:', error);
        alert('Error loading flavor details');
      }
    }

    // Edit flavor
    async function editFlavor(flavorId) {
      try {
        const response = await fetch(`${BASE_URL}/flavors/${flavorId}`);
        if (!response.ok) throw new Error('Failed to fetch flavor details');
        
        const flavor = await response.json();
        
        document.getElementById('flavour-name').value = flavor.flavor_name;
        document.getElementById('additional-price').value = flavor.additional_price;
        
        document.getElementById('add-flavour-form').setAttribute('data-flavour-id', flavorId);
        openAddFlavourModal();
      } catch (error) {
        console.error('Error loading flavor for edit:', error);
        alert('Error loading flavor for edit');
      }
    }

    // Delete flavor
    async function deleteFlavor(flavorId) {
      if (confirm('Are you sure you want to delete this flavor?')) {
        try {
          const response = await fetch(`${BASE_URL}/flavors/${flavorId}`, {
            method: "DELETE"
          });
          if (!response.ok) throw new Error('Failed to delete flavor');
          
          loadFlavors();
          alert('Flavor deleted successfully');
        } catch (error) {
          console.error('Error deleting flavor:', error);
          alert('Error deleting flavor');
        }
      }
    }

    // Modal Functions
    function openAddModal() {
      const activeTab = document.querySelector('.tab-btn.tab-active').id.replace('tab-', '');
      if (activeTab === 'flavors') {
        openAddFlavourModal();
      } else {
        openAddMenuModal();
      }
    }

    function openAddMenuModal() {
      // Load flavors if not already loaded
      if (allFlavors.length === 0) {
        loadFlavors().then(() => {
          populateFlavorCheckboxes();
        });
      } else {
        populateFlavorCheckboxes();
      }
      
      // Set modal title based on whether we're editing or adding
      const modalTitle = document.querySelector('#add-menu-modal .modal-title');
      const isEditing = document.getElementById('add-menu-form').hasAttribute('data-menu-id');
      modalTitle.textContent = isEditing ? 'Edit Menu' : 'Add New Menu';
      
      // If editing, ensure selectedFlavorIds are preserved
      if (isEditing) {
        console.log('Opening edit modal with selectedFlavorIds:', selectedFlavorIds);
        // Re-populate checkboxes to ensure selected flavors are checked
        setTimeout(() => {
          populateFlavorCheckboxes();
        }, 100);
      }
      
      document.getElementById('add-menu-modal').classList.remove('hidden');
    }

    function closeAddMenuModal() {
      document.getElementById('add-menu-form').reset();
      document.getElementById('add-menu-form').removeAttribute('data-menu-id');
      document.getElementById('form-error').textContent = '';
      document.getElementById('form-error').style.color = '';
      // Reset radio button to default (True)
      document.getElementById('is-avail-true').checked = true;
      // Reset flavor selection (only if not already reset)
      if (selectedFlavorIds.length > 0) {
        selectedFlavorIds = [];
        populateFlavorCheckboxes();
      }
      // Reset modal title
      const modalTitle = document.querySelector('#add-menu-modal .modal-title');
      modalTitle.textContent = 'Add New Menu';
      document.getElementById('add-menu-modal').classList.add('hidden');
    }

    function openAddFlavourModal() {
      document.getElementById('add-flavour-modal').classList.remove('hidden');
    }

    function closeAddFlavourModal() {
      document.getElementById('add-flavour-form').reset();
      document.getElementById('add-flavour-form').removeAttribute('data-flavour-id');
      document.getElementById('flavour-form-error').textContent = '';
      document.getElementById('flavour-form-error').style.color = '';
      document.getElementById('add-flavour-modal').classList.add('hidden');
    }

    // View modal functions
    function closeViewMenuModal() {
      document.getElementById('view-menu-modal').classList.add('hidden');
      document.getElementById('view-menu-modal').removeAttribute('data-menu-id');
    }

    function closeViewFlavorModal() {
      document.getElementById('view-flavor-modal').classList.add('hidden');
      document.getElementById('view-flavor-modal').removeAttribute('data-flavor-id');
    }

    function editFromView() {
      const menuId = document.getElementById('view-menu-modal').getAttribute('data-menu-id');
      closeViewMenuModal();
      editMenu(menuId);
    }

    function editFlavorFromView() {
      const flavorId = document.getElementById('view-flavor-modal').getAttribute('data-flavor-id');
      closeViewFlavorModal();
      editFlavor(flavorId);
    }

    // Enhanced search functionality with real-time filtering
    function setupSearch() {
      const menuSearch = document.getElementById('menu-search');
      const flavorSearch = document.getElementById('flavor-search');

      if (menuSearch) {
        menuSearch.addEventListener('input', function() {
          applyMenuFilter();
        });
      }

      if (flavorSearch) {
        flavorSearch.addEventListener('input', function() {
          applyFlavorFilter();
        });
      }
    }

    // Save or update flavour
    async function saveFlavour() {
      const flavourId = document.getElementById('add-flavour-form').getAttribute('data-flavour-id') || null;
      const flavourName = document.getElementById('flavour-name').value;
      const additionalPrice = parseInt(document.getElementById('additional-price').value);

      const data = {
        flavor_name: flavourName,
        additional_price: additionalPrice
      };

      try {
        let response;
        if (flavourId) {
          response = await fetch(`${BASE_URL}/flavors/${flavourId}`, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`${BASE_URL}/flavors`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (!response.ok) {
          let errorMessage = 'Failed to save flavour';
          try {
            const errorData = await response.json();
            errorMessage = errorData.detail || errorData.error || errorMessage;
          } catch (parseError) {
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }
        
        let result;
        try {
          result = await response.json();
          console.log('Flavour saved successfully:', result);
        } catch (parseError) {
          console.log('Flavour saved successfully (no JSON response)');
        }
        
        closeAddFlavourModal();
        loadFlavors();
        
        // Show success message
        const errorElement = document.getElementById('flavour-form-error');
        errorElement.textContent = 'Flavour saved successfully!';
        errorElement.style.color = 'green';
        setTimeout(() => {
          errorElement.textContent = '';
          errorElement.style.color = '';
        }, 3000);
      } catch (error) {
        console.error('Error saving flavour:', error);
        const errorElement = document.getElementById('flavour-form-error');
        errorElement.textContent = error.message || 'Error saving flavour';
        errorElement.style.color = 'red';
      }
    }

    // Event listeners
    document.getElementById('add-menu-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveMenu();
    });

    document.getElementById('add-flavour-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveFlavour();
    });

    // Setup navigation
    function setupNavigation() {
      const navButtons = document.querySelectorAll('.nav-btn');
      
      // Remove active class from all nav buttons first
      navButtons.forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to current page
      const currentPath = window.location.pathname;
      navButtons.forEach(btn => {
        const url = btn.getAttribute('data-url');
        if (url && (currentPath === `/${url}` || (currentPath === '/' && url === 'dashboard'))) {
          btn.classList.add('active');
        }
        
        btn.addEventListener('click', () => {
          if (url) {
            window.location.href = `/${url}`;
          }
        });
      });
    }

    // Flavor Selector Functions
    function populateFlavorCheckboxes() {
      const flavorCheckboxes = document.getElementById('flavor-checkboxes');
      flavorCheckboxes.innerHTML = '';
      
      console.log('Populating flavor checkboxes with selectedFlavorIds:', selectedFlavorIds);
      
      allFlavors.forEach(flavor => {
        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'flavor-checkbox-item';
        const isChecked = selectedFlavorIds.includes(flavor.id);
        checkboxItem.innerHTML = `
          <input type="checkbox" id="flavor-${flavor.id}" value="${flavor.id}" 
                 ${isChecked ? 'checked' : ''} 
                 onchange="updateSelectedFlavors()">
          <label for="flavor-${flavor.id}">
            ${flavor.flavor_name}
            <span class="flavor-price">(+Rp ${flavor.additional_price.toLocaleString()})</span>
          </label>
        `;
        flavorCheckboxes.appendChild(checkboxItem);
      });
    }

    function updateSelectedFlavors() {
      selectedFlavorIds = [];
      const checkboxes = document.querySelectorAll('#flavor-checkboxes input[type="checkbox"]:checked');
      checkboxes.forEach(checkbox => {
        selectedFlavorIds.push(checkbox.value);
      });
    }

    function toggleAllFlavors() {
      const checkboxes = document.querySelectorAll('#flavor-checkboxes input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
      });
      
      updateSelectedFlavors();
    }

    function clearAllFlavors() {
      const checkboxes = document.querySelectorAll('#flavor-checkboxes input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      
      selectedFlavorIds = [];
    }

    // Initial load
    window.addEventListener('load', async () => {
      try {
        // Load menus (flavors are included in menu data)
        await loadMenus();
        
        // Load flavors separately for flavor selector
        await loadFlavors();
        
        switchTab('menu'); // Set default tab
        setupNavigation(); // Setup navigation
        setupSearch(); // Setup search functionality
        
        // Ensure navigation is properly set up after DOM is fully loaded
        setTimeout(() => {
          setupNavigation();
        }, 100);
      } catch (error) {
        console.error('Error during initial load:', error);
        // Show error message to user
        const tbody = document.querySelector('#menu-table tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading data: ' + error.message + '</td></tr>';
        }
      }
    });
  </script>
</body>
</html>